<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>timers.scala</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=2;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Jacoco Coverage Report</a> &gt; <a href="index.source.html" class="el_package">rummage</a> &gt; <span class="el_source">timers.scala</span></div><h1>timers.scala</h1><pre class="source lang-java linenums">/* timers.scala
 * 
 * Copyright (c) 2013-2014 bizo.com
 * Copyright (c) 2013-2014 zman.io
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package rummage

import java.util.concurrent.{ Executors, ThreadFactory, ScheduledExecutorService, ScheduledFuture }
import java.util.concurrent.TimeUnit.MILLISECONDS
import java.util.concurrent.atomic.AtomicLong
import scala.concurrent.ExecutionContext
import scala.concurrent.duration._
import akka.actor.{ ActorSystem, Cancellable, Scheduler }

/**
 * An interface for scheduling tasks to run one or more times at some point in the future.
 */
<span class="fc" id="L30">trait Timer {</span>

  import Timer.Task

  /**
   * Creates a builder capable of building timers that perform a task once or repeatedly after the specified delay.
   *
   * @param delay The amount of time to wait before performing the task for the first time.
   */
<span class="fc" id="L39">  def after(delay: FiniteDuration): Builder = new Builder(delay)</span>

  /**
   * Performs a task after the specified delay and repeatedly thereafter, waiting the specified interval between
   * invocations.
   *
   * @tparam U Any type, treated as if it was `Unit`.
   * @param interval The amount of time to wait before performing the task and between subsequent executions.
   * @param f The action to repeatedly perform.
   * @param ec The execution context to perform the action on.
   */
  def every[U](interval: FiniteDuration)(f: =&gt; U)(implicit ec: ExecutionContext): Task =
<span class="pc" id="L51">    submit(interval, Some(interval), f _)</span>

  /**
   * Submits a task for execution after the specified delay and possibly repeatedly thereafter, waiting the specified
   * interval (if specified) between invocations.
   *
   * @param delay The amount of time to wait before performing the task for the first time.
   * @param interval A `Some` containing the amount of time to wait between subsequent executions or `None`.
   * @param f The action to (possibly repeatedly) perform.
   * @param ec The execution context to perform the action on.
   */
  def submit(delay: FiniteDuration, interval: Option[FiniteDuration], f: () =&gt; Unit)(
    implicit ec: ExecutionContext): Task

  /**
   * A secondary interface for building tasks that fire after an initial delay.
   *
   * @param delay The initial delay duration.
   */
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">  final class Builder private[Timer] (delay: FiniteDuration) {</span>

    /**
     * Performs a task once after this builder's delay.
     *
     * @tparam U Any type, treated as if it was `Unit`.
     * @param f The action to perform after the specified delay.
     * @param ec The execution context to perform the action on.
     */
    def apply[U](f: =&gt; U)(implicit ec: ExecutionContext): Task =
<span class="pc" id="L80">      submit(delay, None, f _)</span>

    /**
     * Performs a task once after this builder's delay and repeatedly thereafter, waiting the specified interval
     * between subsequent invocations.
     *
     * @tparam U Any type, treated as if it was `Unit`.
     * @param interval The amount of time to wait between subsequent executions.
     * @param f The action to repeatedly perform.
     * @param ec The execution context to perform the action on.
     */
    def andEvery[U](interval: FiniteDuration)(f: =&gt; U)(implicit ec: ExecutionContext): Task =
<span class="pc" id="L92">      submit(delay, Some(interval), f _)</span>

  }

}

/**
 * Definitions associated with timers as well as the infrastructure for publishing the global implicit timer.
 *
 * This object publishes an implicit, lazily-initialized, global timer backed by a single daemon thread. It
 * additionally implements `Timer` itself and forwards all task submissions to the aforementioned global timer.
 */
<span class="nc" id="L104">object Timer extends Timer {</span>

  /** The default global timer backed by a single thread. */
<span class="nc bnc" id="L107" title="All 2 branches missed.">  implicit lazy val global: Timer = new JavaTimer(Executors.newSingleThreadScheduledExecutor(new ThreadFactory {</span>
<span class="nc" id="L108">    val counter = new AtomicLong</span>
    def newThread(r: Runnable) = {
<span class="nc" id="L110">      val thread = new Thread(r, s&quot;${classOf[Timer].getName}-${counter.incrementAndGet()}&quot;)</span>
<span class="nc" id="L111">      thread.setDaemon(true)</span>
<span class="nc" id="L112">      thread</span>
    }
  }))

  /* Delegates to the global timer instance. */
  def submit(delay: FiniteDuration, interval: Option[FiniteDuration], f: () =&gt; Unit)(implicit ec: ExecutionContext) =
<span class="nc" id="L118">    global.submit(delay, interval, f)</span>

  /**
   * Represents a task spawned by a timer.
   */
  trait Task {

    /** Returns true if this task has been cancelled. */
    def isCancelled: Boolean

    /** Cancels this task. */
    def cancel(): Unit

  }

}

/**
 * A timer implemented with a Java `ScheduledExecutorService`.
 *
 * @param executor The `ScheduledExecutorService` instance to view as a timer.
 */
<span class="fc" id="L140">final class JavaTimer(executor: ScheduledExecutorService) extends Timer {</span>
  def submit(delay: FiniteDuration, interval: Option[FiniteDuration], f: () =&gt; Unit)(implicit ec: ExecutionContext) = {
<span class="fc" id="L142">    @volatile var handle = None: Option[ScheduledFuture[_]]</span>
<span class="pc bnc" id="L143" title="All 4 branches missed.">    val nested = new Runnable { def run = if (handle forall (!_.isCancelled)) f() }</span>
<span class="pc" id="L144">    val action = new Runnable { def run = ec execute nested }</span>
<span class="pc" id="L145">    val future = interval match {</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">      case Some(interval) =&gt; executor.scheduleAtFixedRate(action, delay.toMillis, interval.toMillis, MILLISECONDS)</span>
<span class="pc bpc" id="L147" title="4 of 6 branches missed.">      case None =&gt; executor.schedule(action, delay.toMillis, MILLISECONDS)</span>
    }
<span class="fc" id="L149">    handle = Some(future)</span>
<span class="fc" id="L150">    new Timer.Task {</span>
<span class="fc" id="L151">      def isCancelled = future.isCancelled</span>
<span class="fc" id="L152">      def cancel() = future.cancel(false)</span>
    }: Timer.Task
  }
}

/**
 * Factory for timers implemented with a Java `ScheduledExecutorService`.
 */
<span class="fc" id="L160">object JavaTimer {</span>

  /**
   * Creates a Java timer from the specified executor.
   *
   * @param executor The `ScheduledExecutorService` instance to view as a timer.
   */
  def apply(executor: ScheduledExecutorService): JavaTimer = new JavaTimer(executor)

}

/**
 * A timer implemented with an Akka `Scheduler`.
 *
 * @param scheduler The `Scheduler` instance to view as a timer.
 */
<span class="fc" id="L176">final class AkkaTimer(scheduler: Scheduler) extends Timer {</span>
  def submit(delay: FiniteDuration, interval: Option[FiniteDuration], f: () =&gt; Unit)(implicit ec: ExecutionContext) = {
<span class="fc" id="L178">    @volatile var handle = None: Option[Cancellable]</span>
<span class="pc bnc" id="L179" title="All 4 branches missed.">    val action = new Runnable { def run = if (handle forall (!_.isCancelled)) f() }</span>
<span class="pc" id="L180">    val cancellable = interval match {</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">      case Some(interval) =&gt; scheduler.schedule(delay, interval, action)</span>
<span class="pc bpc" id="L182" title="4 of 6 branches missed.">      case None =&gt; scheduler.scheduleOnce(delay, action)</span>
    }
<span class="fc" id="L184">    handle = Some(cancellable)</span>
<span class="fc" id="L185">    new Timer.Task {</span>
<span class="fc" id="L186">      def isCancelled = cancellable.isCancelled</span>
<span class="fc" id="L187">      def cancel() = cancellable.cancel()</span>
    }: Timer.Task
  }
}

/**
 * Factory for timers implemented with an Akka `Scheduler`.
 */
<span class="fc" id="L195">object AkkaTimer {</span>

  /**
   * Creates an Akka timer from the specified scheduler.
   *
   * @param scheduler The `Scheduler` instance to view as a timer.
   */
  def apply(scheduler: Scheduler): AkkaTimer = new AkkaTimer(scheduler)

  /**
   * Creates an Akka timer from the specified actor system's scheduler.
   *
   * @param system The actor system that contains the scheduler to view as a timer.
   */
  def apply(system: ActorSystem): AkkaTimer = AkkaTimer(system.scheduler)

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312101107</span></div></body></html>